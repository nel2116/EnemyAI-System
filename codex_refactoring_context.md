# Codex リファクタリング依頼コンテキスト

## プロジェクト概要

このプロジェクトは、独自エンジン（via）に依存したエネミー AI システムです。クリーンアーキテクチャ風の設計を採用していますが、エンジン依存や継承設計など複数の問題点が存在します。

## 主要な問題点

### 1. エンジン依存の問題

- Domain 層が via エンジン固有の型（`GameObject`, `vec3`）に依存
- ローカル環境でのテストが困難
- エンジン環境なしでの開発ができない

### 2. 継承設計による拡張性の制限

- `TwinGoblinAI : BasicEnemyAI`の継承設計
- 複数の特殊エネミーに対応困難
- 状態管理の複雑化

### 3. ファクトリの拡張性不足

- 新しいエネミータイプ追加時に Enum とビルダーを変更
- Open/Closed Principle に反している

## リファクタリング目標

### Phase 1: エンジン依存の分離（最優先）

- Domain 層から via エンジン型を完全に排除
- 抽象化インターフェースの強化
- アダプター層の実装

### Phase 2: コンポジション優先設計への移行

- ビヘイビアコンポーネントの導入
- 継承からコンポジションへの変更
- 型安全性の向上

### Phase 3: ファクトリの拡張性改善

- ビルダーパターンの導入
- 設定駆動設計の強化

## 現在のアーキテクチャ

```
LocalCode/
├── Domain/           # ドメイン層（ビジネスロジック）
├── Application/      # アプリケーション層（ユースケース）
├── Infrastructure/   # インフラ層（実装詳細）
├── Data/            # データ層（設定データ）
├── Presentation/    # プレゼンテーション層（UI）
└── Via/             # エンジン接着層
```

## 重要な制約

1. **データ駆動設計の維持**: `EnemyUserData.cs`と`TwinGoblinUserData.cs`の構造を維持
2. **デザイナー向けパラメータ調整**: via エンジンのインスペクターで調整可能な状態を維持
3. **既存機能の保持**: 現在の AI 機能（パトロール、追跡、攻撃、帰還）を維持
4. **段階的移行**: 既存コードを最小限の変更で適応可能

## 期待する成果

1. **エンジン非依存の Domain 層**: via エンジンなしでテスト可能
2. **新エネミー実装の容易化**: コード変更なしに新しいエネミーを追加可能
3. **型安全性の向上**: キャストを排除し、コンパイル時にエラーを検出
4. **テスト容易性の向上**: 各コンポーネントが独立してテスト可能
